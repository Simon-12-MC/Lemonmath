<Module>
<ModulePrefs title="Lemon Games | Eaglercraft"/>
<Content type="html">
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lemon Games</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; font-family:'Poppins',sans-serif; overflow:hidden; background:#0d0d0d; color:#fff; display:flex; justify-content:center; align-items:center; }

#menu { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10; transition:opacity 0.5s ease; }
#menu.fade-out { opacity:0; pointer-events:none; }

h1 { font-size:3rem; margin-bottom:2rem; text-shadow:0 0 20px rgba(60,175,255,0.5); }

.play-button { padding:1rem 3rem; font-size:1.5rem; font-weight:700; border:none; border-radius:10px; cursor:pointer; background:#3cafff; color:#fff; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow:0 4px 15px rgba(60,175,255,0.3); }
.play-button:hover { transform:scale(1.05); box-shadow:0 6px 20px rgba(60,175,255,0.5); }

/* Live Counter */
.live-counter { position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.7); padding:12px 20px; border-radius:25px; display:flex; align-items:center; gap:10px; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); z-index:20; }
.live-dot { width:12px; height:12px; background:#ff3030; border-radius:50%; animation:pulse 2s ease-in-out infinite; box-shadow:0 0 10px #ff3030; }
@keyframes pulse { 0%, 100% { opacity:1; transform:scale(1); } 50% { opacity:0.6; transform:scale(0.9); } }
.counter-text { font-size:0.9rem; font-weight:600; color:#fff; }
.counter-number { font-size:1.1rem; font-weight:700; color:#3cafff; margin-left:5px; }

#loading { position:absolute; top:0; left:0; width:100%; height:100%; background:#111; display:none; flex-direction:column; justify-content:center; align-items:center; z-index:9; }
.spinner { width:50px; height:50px; border:4px solid rgba(255,255,255,0.1); border-top-color:#3cafff; border-radius:50%; animation:spin 0.8s linear infinite; margin-bottom:15px; }
@keyframes spin { to { transform:rotate(360deg); } }
.loading-text { font-size:1.2rem; color:#aaa; font-weight:600; text-align:center; max-width:300px; }

#game_frame { width:100%; height:100%; display:none; background:#000; position:absolute; top:0; left:0; }

/* Watermark */
.watermark { position:fixed; bottom:15px; left:50%; transform:translateX(-50%); font-size:0.85rem; font-weight:600; color:rgba(255,255,255,0.4); z-index:100; text-shadow:0 1px 3px rgba(0,0,0,0.5); pointer-events:none; letter-spacing:1px; }

/* Smooth floating dots */
.dot { position:absolute; width:6px; height:6px; background:#fff; border-radius:50%; opacity:0.6; pointer-events:none; transition:opacity 0.5s ease; will-change:transform; }
</style>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/mece188/feh@main/classes.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/mece188/feh@main/fix-webm-duration.js"></script>
</head>
<body>

<div id="menu">
  <h1>üçã Lemon Games</h1>
  <button class="play-button" id="playBtn">‚ñ∂ Play</button>
</div>

<div class="live-counter">
  <div class="live-dot"></div>
  <span class="counter-text">Visitors Online:<span class="counter-number" id="playerCount">...</span></span>
</div>

<div id="loading">
  <div class="spinner"></div>
  <div class="loading-text">Loading Eaglercraft 1.8.8 WASM...</div>
</div>

<div id="game_frame"></div>

<div class="watermark">LEMON GAMES</div>

<script>
// Real visitor counter using storage
const STORAGE_KEY = 'lemon-games-visitors';
const SESSION_KEY = 'lemon-session-' + Date.now() + '-' + Math.random();
const HEARTBEAT_INTERVAL = 5000; // 5 seconds
const VISITOR_TIMEOUT = 15000; // 15 seconds

let visitorCount = 0;
const playerCountEl = document.getElementById('playerCount');

async function updateVisitorCount() {
  try {
    // Get current visitors
    let visitors = {};
    try {
      const result = await window.storage.get(STORAGE_KEY, true);
      if (result && result.value) {
        visitors = JSON.parse(result.value);
      }
    } catch (e) {
      // Key doesn't exist yet, start fresh
      visitors = {};
    }

    // Clean up stale visitors
    const now = Date.now();
    Object.keys(visitors).forEach(key => {
      if (now - visitors[key] > VISITOR_TIMEOUT) {
        delete visitors[key];
      }
    });

    // Add/update current session
    visitors[SESSION_KEY] = now;

    // Save back to storage
    await window.storage.set(STORAGE_KEY, JSON.stringify(visitors), true);

    // Update count
    visitorCount = Object.keys(visitors).length;
    playerCountEl.textContent = visitorCount;
  } catch (error) {
    console.error('Storage error:', error);
    // Fallback to showing at least 1 (this user)
    playerCountEl.textContent = '1';
  }
}

// Initial update
updateVisitorCount();

// Send heartbeat every 5 seconds
setInterval(updateVisitorCount, HEARTBEAT_INTERVAL);

// Cleanup on page unload
window.addEventListener('beforeunload', async () => {
  try {
    const result = await window.storage.get(STORAGE_KEY, true);
    if (result && result.value) {
      const visitors = JSON.parse(result.value);
      delete visitors[SESSION_KEY];
      await window.storage.set(STORAGE_KEY, JSON.stringify(visitors), true);
    }
  } catch (e) {
    // Ignore errors on unload
  }
});

// Optimized smooth floating dots with better performance
const dots = [];
const numDots = 100;

for(let i = 0; i < numDots; i++){
  const dot = document.createElement('div');
  dot.className = 'dot';
  const size = Math.random() * 3 + 2;
  dot.style.width = dot.style.height = size + 'px';
  
  const x = Math.random() * window.innerWidth;
  const y = Math.random() * window.innerHeight;
  
  dot.style.left = x + 'px';
  dot.style.top = y + 'px';
  dot.style.opacity = Math.random() * 0.4 + 0.3;
  
  const colors = ['#fff', '#3cafff', '#ffd700'];
  dot.style.background = colors[Math.floor(Math.random() * colors.length)];
  
  dot.dataset.x = x;
  dot.dataset.y = y;
  dot.dataset.vx = (Math.random() - 0.5) * 0.3;
  dot.dataset.vy = (Math.random() - 0.5) * 0.3;
  
  document.body.appendChild(dot);
  dots.push(dot);
}

let lastTime = performance.now();

function animateDots(currentTime) {
  const deltaTime = (currentTime - lastTime) / 16;
  lastTime = currentTime;
  
  dots.forEach(dot => {
    let x = parseFloat(dot.dataset.x);
    let y = parseFloat(dot.dataset.y);
    const vx = parseFloat(dot.dataset.vx);
    const vy = parseFloat(dot.dataset.vy);
    
    x += vx * deltaTime;
    y += vy * deltaTime;
    
    if(x < -10) x = window.innerWidth + 10;
    if(x > window.innerWidth + 10) x = -10;
    if(y < -10) y = window.innerHeight + 10;
    if(y > window.innerHeight + 10) y = -10;
    
    dot.dataset.x = x;
    dot.dataset.y = y;
    dot.style.transform = `translate(${x}px, ${y}px)`;
  });
  
  requestAnimationFrame(animateDots);
}

dots.forEach(dot => {
  dot.style.left = '0';
  dot.style.top = '0';
});

animateDots(performance.now());

const playBtn = document.getElementById('playBtn');
const menu = document.getElementById('menu');
const loadingDiv = document.getElementById('loading');
const gameFrame = document.getElementById('game_frame');

playBtn.addEventListener('click', () => {
    menu.classList.add('fade-out');
    dots.forEach(dot => { 
      dot.style.transition = 'opacity 0.5s ease'; 
      dot.style.opacity = '0'; 
    });

    setTimeout(() => {
        loadingDiv.style.display = 'flex';
        setTimeout(() => {
            loadingDiv.style.display = 'none';
            gameFrame.style.display = 'flex';

            if(!window.eaglercraftXOpts){
              window.eaglercraftXOpts = {
                container: "game_frame",
                assetsURI: "https://cdn.jsdelivr.net/gh/mece188/feh@main/assets.epk",
                localesURI: "lang/",
                servers: [
                  {addr: "wss://mc.arch.lol/", name: "ArchMC"},
                  {addr: "wss://mc.asspixel.net", name: "AssPixel"},
                  {addr: "wss://sus.shhnowisnottheti.me", name: "Ayunboom"},
                  {addr: "wss://aeon-network.net/1.8", name: "Aeon"},
                  {addr: "wss://zentic.org/", name: "Zentic"}
                ]
              };
            }

            try { 
              main(); 
            } catch(e) { 
              console.error("Error starting EaglercraftX:", e);
            }
        }, 3000);
    }, 500);
});
</script>

</body>
</html>
</Content>
</Module>
